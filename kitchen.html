<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Kitchen Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 15px;
}

h1 {
  text-align: center;
}

.order {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.order h2 {
  margin: 0 0 5px;
}

.order ul {
  padding-left: 18px;
}

.order li {
  margin-bottom: 8px;
}

.status {
  font-weight: bold;
  margin-bottom: 10px;
}

.buttons {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.buttons button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
}

.new { background: #555; }
.cooking { background: orange; }
.ready { background: green; }
.done { background: #999; }
</style>
</head>

<body>

<h1>üë®‚Äçüç≥ Kitchen Orders</h1>
<div id="orders"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ================== FIREBASE ================== */
const firebaseConfig = {
  apiKey: "AIzaSyD9x_Fvec4nkEHWVJ6D02xDvW",
  authDomain: "qr-menu-fe159.firebaseapp.com",
  projectId: "qr-menu-fe159",
  storageBucket: "qr-menu-fe159.appspot.com",
  messagingSenderId: "105707127728",
  appId: "1:105707127728:web:65dee4362f74b67f35cc75"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const ordersDiv = document.getElementById("orders");
let latestSnapshot = null;

/* ================== STATUS UPDATE ================== */
function setStatus(id, status) {
  if (status === "done") {
    // Delete the order
    db.collection("orders").doc(id).delete()
      .then(() => {
        console.log("Order deleted");
      })
      .catch(err => console.error(err));
  } else {
    // Update status normally
    db.collection("orders").doc(id).update({ status })
      .then(() => {
        console.log("Status updated");
      })
      .catch(err => console.error(err));
  }
}

/* ================== TIME AGO ================== */
function timeAgo(timestamp) {
  if (!timestamp) return "";

  const now = new Date();
  const orderTime = timestamp.toDate();
  const diffSec = Math.floor((now - orderTime) / 1000);

  if (diffSec < 60) return "Just now";
  if (diffSec < 3600) return `${Math.floor(diffSec / 60)} min ago`;
  if (diffSec < 86400) return `${Math.floor(diffSec / 3600)} hr ago`;

  return `${Math.floor(diffSec / 86400)} day ago`;
}

/* ================== RENDER ORDERS ================== */
function renderOrders(snapshot) {
  ordersDiv.innerHTML = "";

  snapshot.forEach(doc => {
    const o = doc.data();

    const orderDiv = document.createElement("div");
    orderDiv.className = "order";

    /* ----- HEADER (FIXED TAKEAWAY + TABLE) ----- */
    let header = "";
    if (o.type?.toLowerCase() === "takeaway") {
      header = o.table
        ? `ü•° Take Away (Table ${o.table})`
        : "ü•° Take Away";
    } else {
      header = `üçΩÔ∏è Table ${o.table}`;
    }

    /* ----- ITEMS ----- */
    let itemsHTML = "";
    o.items.forEach(item => {
      let opts = "";
      if (item.choices) {
        Object.values(item.choices).forEach(v => {
          opts += v + ", ";
        });
      }

      itemsHTML += `
        <li>
          <strong>${item.name}</strong> x${item.qty}<br>
          <small>
            Options: ${opts || "None"}<br>
            Add-ons: ${item.addons?.join(", ") || "None"}
          </small>
        </li>
      `;
    });

    const ago = timeAgo(o.time);

    orderDiv.innerHTML = `
      <h2>${header}</h2>
      <div class="status">
        Status: ${o.status.toUpperCase()}
        ${ago ? ` ‚Ä¢ üïí ${ago}` : ""}
      </div>

      <ul>${itemsHTML}</ul>

      <div class="buttons">
        <button class="new" onclick="setStatus('${doc.id}','new')">New</button>
        <button class="cooking" onclick="setStatus('${doc.id}','cooking')">Cooking</button>
        <button class="ready" onclick="setStatus('${doc.id}','ready')">Ready</button>
        <button class="done" onclick="setStatus('${doc.id}','done')">Done</button>
      </div>
    `;

    ordersDiv.appendChild(orderDiv);
  });
}

/* ================== FIRESTORE LISTENER ================== */
db.collection("orders")
  .orderBy("time", "asc")
  .onSnapshot(snapshot => {
    latestSnapshot = snapshot;
    renderOrders(snapshot);
  });

/* ================== AUTO TIME REFRESH ================== */
setInterval(() => {
  if (latestSnapshot) {
    renderOrders(latestSnapshot);
  }
}, 30000); // update every 30 seconds
</script>
</body>
</html>