<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cart</title>

<style>
body {
  font-family: Arial;
  margin: 0;
  padding: 20px;
  background:#f9f9f9;
}

h1 { text-align:center; }

.cart-item {
  background: white;
  padding: 15px;
  margin-bottom: 12px;
  border-radius:10px;
}

.cart-item h3 { margin: 0; }

.cart-item p {
  margin: 5px 0;
  color: #555;
  font-size:14px;
}

button {
  padding:8px 12px;
  cursor:pointer;
  border-radius:6px;
}

.remove {
  background:red;
  color:white;
  border:none;
}

.summary {
  background:white;
  padding:15px;
  border-radius:10px;
  margin-top:15px;
}

.summary div {
  display:flex;
  justify-content:space-between;
  margin:6px 0;
}

.actions {
  display:flex;
  gap:10px;
  margin-top:15px;
}

.checkout {
  flex:1;
  background:#111;
  color:white;
  border:none;
}

.addmore {
  flex:1;
  background:#ddd;
  border:none;
}
</style>
</head>

<body>

<h1>Your Cart</h1>
<div id="cart"></div>

<div class="summary">
  <div><span>Subtotal</span><span id="subtotal">RM 0.00</span></div>
  <div><span>Service Charge (5%)</span><span id="service">RM 0.00</span></div>
  <div><span>Tax (2%)</span><span id="tax">RM 0.00</span></div>
  <div><strong>Grand Total</strong><strong id="grand">RM 0.00</strong></div>
</div>

<div class="actions">
  <button class="addmore" onclick="goBack()">Add Items</button>
  <button class="checkout" onclick="checkout()">Checkout</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD9x_Fvec4nkEHWVJ6D02xDvWqwmCXk81k",
  authDomain: "qr-menu-fe159.firebaseapp.com",
  projectId: "qr-menu-fe159",
  storageBucket: "qr-menu-fe159.appspot.com",
  messagingSenderId: "105707127728",
  appId: "1:105707127728:web:65dee4362f74b67f35cc75"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
const params = new URLSearchParams(window.location.search);
const table = params.get("table");
const type = localStorage.getItem("orderType");

let cart = JSON.parse(localStorage.getItem("cart") || "[]");

const cartDiv = document.getElementById("cart");

function renderCart() {
  cartDiv.innerHTML = "";
  let subtotal = 0;

  cart.forEach((item, i) => {
    const d = document.createElement("div");
    d.className = "cart-item";

    let optionText = "";
    for (let k in item.choices) {
      optionText += `${k}: ${item.choices[k]}<br>`;
    }

    d.innerHTML = `
      <h3>${item.name} Ã— ${item.qty}</h3>
      <p>${optionText}</p>
      <p>Add-ons: ${item.addons.length ? item.addons.join(", ") : "None"}</p>
      <p>${item.total}</p>
      <button class="remove" onclick="removeItem(${i})">Remove</button>
    `;

    cartDiv.appendChild(d);

    subtotal += Number(item.total.replace("Total: RM ", "")) * item.qty;
  });

  calculateTotal(subtotal);
}

function calculateTotal(subtotal) {
  const service = subtotal * 0.05;
  const tax = subtotal * 0.02;
  let grand = subtotal + service + tax;

  // Malaysia rounding to nearest 0.05
  grand = Math.round(grand * 20) / 20;

  document.getElementById("subtotal").innerText = "RM " + subtotal.toFixed(2);
  document.getElementById("service").innerText = "RM " + service.toFixed(2);
  document.getElementById("tax").innerText = "RM " + tax.toFixed(2);
  document.getElementById("grand").innerText = "RM " + grand.toFixed(2);
}

function removeItem(i) {
  cart.splice(i, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

function goBack() {
  history.back();
}

function checkout() {
  if (!cart.length) {
    alert("Cart is empty");
    return;
  }

  db.collection("orders").add({
    table: table || "TA",
    type: type || "takeaway",
    items: cart,
    status: "new",
    time: firebase.firestore.FieldValue.serverTimestamp()
  })
  .then(() => {
    alert("Order sent to kitchen ðŸ‘¨â€ðŸ³");
    localStorage.removeItem("cart");
    cart = [];
    renderCart();
  })
  .catch(e => alert(e.message));
}

renderCart();
</script>
</body>
</html>